name: Birthday Notifications

on:
  schedule:
    # –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 06:00 UTC (09:00 –ø–æ –ú–æ—Å–∫–≤–µ)
    - cron: '0 6 * * *'
  workflow_dispatch: # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  check_birthdays:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-github.txt
        
    - name: Check secrets availability
      run: |
        echo "Checking secrets availability..."
        if [ -n "${{ secrets.BOT_TOKEN }}" ]; then
          echo "‚úÖ BOT_TOKEN is available"
        else
          echo "‚ùå BOT_TOKEN is not available - workflow will fail"
        fi
        
        if [ -n "${{ secrets.CHAT_ID }}" ]; then
          echo "‚úÖ CHAT_ID is available"
        else
          echo "‚ùå CHAT_ID is not available - workflow will fail"
        fi
        
        if [ -n "${{ secrets.GOOGLE_SHEETS_CREDENTIALS }}" ]; then
          echo "‚úÖ GOOGLE_SHEETS_CREDENTIALS is available"
        else
          echo "‚ùå GOOGLE_SHEETS_CREDENTIALS is not available - workflow will fail"
        fi
        
        if [ -n "${{ secrets.SPREADSHEET_ID }}" ]; then
          echo "‚úÖ SPREADSHEET_ID is available"
        else
          echo "‚ùå SPREADSHEET_ID is not available - workflow will fail"
        fi
        
    - name: Run Birthday Notifications
      env:
        BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
        CHAT_ID: ${{ secrets.CHAT_ID }}
        GOOGLE_SHEETS_CREDENTIALS: ${{ secrets.GOOGLE_SHEETS_CREDENTIALS }}
        SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
      run: |
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
        if [ -z "$BOT_TOKEN" ]; then
          echo "‚ùå –û–®–ò–ë–ö–ê: BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ GitHub Secrets"
          echo "–î–æ–±–∞–≤—å—Ç–µ BOT_TOKEN –≤ Settings ‚Üí Secrets and variables ‚Üí Actions"
          exit 1
        fi
        
        if [ -z "$CHAT_ID" ]; then
          echo "‚ùå –û–®–ò–ë–ö–ê: CHAT_ID –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ GitHub Secrets"
          echo "–î–æ–±–∞–≤—å—Ç–µ CHAT_ID –≤ Settings ‚Üí Secrets and variables ‚Üí Actions"
          exit 1
        fi
        
        if [ -z "$GOOGLE_SHEETS_CREDENTIALS" ]; then
          echo "‚ùå –û–®–ò–ë–ö–ê: GOOGLE_SHEETS_CREDENTIALS –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ GitHub Secrets"
          echo "–î–æ–±–∞–≤—å—Ç–µ GOOGLE_SHEETS_CREDENTIALS –≤ Settings ‚Üí Secrets and variables ‚Üí Actions"
          exit 1
        fi
        
        if [ -z "$SPREADSHEET_ID" ]; then
          echo "‚ùå –û–®–ò–ë–ö–ê: SPREADSHEET_ID –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ GitHub Secrets"
          echo "–î–æ–±–∞–≤—å—Ç–µ SPREADSHEET_ID –≤ Settings ‚Üí Secrets and variables ‚Üí Actions"
          exit 1
        fi
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (—Å–∫—Ä—ã–≤–∞–µ–º —Ç–æ–∫–µ–Ω)
        echo "BOT_TOKEN: ${BOT_TOKEN:0:10}..."
        echo "CHAT_ID: $CHAT_ID"
        echo "SPREADSHEET_ID: $SPREADSHEET_ID"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Python —Å–∫—Ä–∏–ø—Ç–∞
        if [ ! -f "run_birthday_notifications.py" ]; then
          echo "‚ùå –§–∞–π–ª run_birthday_notifications.py –Ω–µ –Ω–∞–π–¥–µ–Ω"
          exit 1
        fi
        
        echo "–ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –¥–Ω—è—Ö —Ä–æ–∂–¥–µ–Ω–∏—è..."
        echo "=================================================="
        
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
        echo "üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ü–ï–†–ï–ú–ï–ù–ù–´–• –û–ö–†–£–ñ–ï–ù–ò–Ø:"
        echo "SPREADSHEET_ID –¥–ª–∏–Ω–∞: ${#SPREADSHEET_ID}"
        echo "GOOGLE_SHEETS_CREDENTIALS –¥–ª–∏–Ω–∞: ${#GOOGLE_SHEETS_CREDENTIALS}"
        echo "–ü–µ—Ä–≤—ã–µ 50 —Å–∏–º–≤–æ–ª–æ–≤ GOOGLE_SHEETS_CREDENTIALS: ${GOOGLE_SHEETS_CREDENTIALS:0:50}..."
        
        python run_birthday_notifications.py
        
        echo "=================================================="
        echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
        
    - name: Handle errors
      if: failure()
      env:
        BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
        CHAT_ID: ${{ secrets.CHAT_ID }}
      run: |
        echo "‚ùå GitHub Actions –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π"
        echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ..."
        
        if [ -z "$BOT_TOKEN" ]; then
          echo "‚ö†Ô∏è BOT_TOKEN –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ"
          echo "–î–æ–±–∞–≤—å—Ç–µ BOT_TOKEN –≤ GitHub Secrets –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ–± –æ—à–∏–±–∫–∞—Ö"
        fi
        
        if [ -z "$CHAT_ID" ]; then
          echo "‚ö†Ô∏è CHAT_ID –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ"
          echo "–î–æ–±–∞–≤—å—Ç–µ CHAT_ID –≤ GitHub Secrets –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ–± –æ—à–∏–±–∫–∞—Ö"
        fi
        
        echo "–û—à–∏–±–∫–∏ –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç —á–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç"
