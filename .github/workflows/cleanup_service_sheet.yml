name: Cleanup Service Sheet

on:
  schedule:
    # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 02:00 UTC (05:00 –ú–°–ö)
    - cron: '0 2 * * *'
  workflow_dispatch: # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

jobs:
  cleanup-service-sheet:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install python-telegram-bot gspread google-auth python-dotenv
        
    - name: Create .env file
      run: |
        echo "üîß –°–û–ó–î–ê–ù–ò–ï –§–ê–ô–õ–ê .ENV"
        echo "=================================================="
        
        # –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π .env —Ñ–∞–π–ª
        touch .env
        
        # –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ –ø—É—Å—Ç—ã–µ
        if [ ! -z "${{ secrets.BOT_TOKEN }}" ]; then
          echo "BOT_TOKEN=${{ secrets.BOT_TOKEN }}" >> .env
          echo "‚úÖ BOT_TOKEN –¥–æ–±–∞–≤–ª–µ–Ω –≤ .env"
        else
          echo "‚ö†Ô∏è BOT_TOKEN –ø—É—Å—Ç–æ–π, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
        fi
        
        if [ ! -z "${{ secrets.CHAT_ID }}" ]; then
          echo "CHAT_ID=${{ secrets.CHAT_ID }}" >> .env
          echo "‚úÖ CHAT_ID –¥–æ–±–∞–≤–ª–µ–Ω –≤ .env"
        else
          echo "‚ö†Ô∏è CHAT_ID –ø—É—Å—Ç–æ–π, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
        fi
        
        if [ ! -z "${{ secrets.GOOGLE_SHEETS_CREDENTIALS }}" ]; then
          echo "GOOGLE_SHEETS_CREDENTIALS='${{ secrets.GOOGLE_SHEETS_CREDENTIALS }}'" >> .env
          echo "‚úÖ GOOGLE_SHEETS_CREDENTIALS –¥–æ–±–∞–≤–ª–µ–Ω –≤ .env"
        else
          echo "‚ö†Ô∏è GOOGLE_SHEETS_CREDENTIALS –ø—É—Å—Ç–æ–π, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
        fi
        
        if [ ! -z "${{ secrets.SPREADSHEET_ID }}" ]; then
          echo "SPREADSHEET_ID=${{ secrets.SPREADSHEET_ID }}" >> .env
          echo "‚úÖ SPREADSHEET_ID –¥–æ–±–∞–≤–ª–µ–Ω –≤ .env"
        else
          echo "‚ö†Ô∏è SPREADSHEET_ID –ø—É—Å—Ç–æ–π, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
        fi
        
        echo "=================================================="
        
    - name: Run cleanup script
      run: |
        echo "üßπ –ó–ê–ü–£–°–ö –°–ö–†–ò–ü–¢–ê –û–ß–ò–°–¢–ö–ò –°–ï–†–í–ò–°–ù–û–ì–û –õ–ò–°–¢–ê"
        echo "=================================================="
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç –æ—á–∏—Å—Ç–∫–∏
        python cleanup_service_sheet.py
        
        echo "=================================================="
        
    - name: Cleanup
      if: always()
      run: |
        echo "üßπ –û–ß–ò–°–¢–ö–ê –í–†–ï–ú–ï–ù–ù–´–• –§–ê–ô–õ–û–í"
        echo "=================================================="
        
        # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
        if [ -f ".env" ]; then
          rm .env
          echo "‚úÖ .env —Ñ–∞–π–ª —É–¥–∞–ª–µ–Ω"
        fi
        
        echo "=================================================="
