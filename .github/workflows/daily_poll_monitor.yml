name: Daily Poll Monitor

on:
  schedule:
    # –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 12:00 UTC = 15:00 MSK
    - cron: '0 12 * * *'
    # –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 00:00 UTC = 03:00 MSK
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      action:
        description: '–î–µ–π—Å—Ç–≤–∏–µ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è'
        required: true
        default: 'monitor'
        type: choice
        options:
        - monitor
        - test

jobs:
  daily-monitor:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Restore poll votes cache
      uses: actions/cache@v3
      with:
        path: |
          poll_votes_*.json
        key: poll-votes-${{ github.ref }}
        restore-keys: |
          poll-votes-
        
    - name: Check poll votes files
      run: |
        echo "üîç –ü–†–û–í–ï–†–ö–ê –§–ê–ô–õ–û–í –ì–û–õ–û–°–û–í–ê–ù–ò–ô"
        echo "=================================================="
        echo "üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–æ–≤ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–π:"
        ls -la poll_votes_*.json 2>/dev/null || echo "‚ÑπÔ∏è –§–∞–π–ª—ã –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω—ã (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞)"
        echo "=================================================="
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install python-telegram-bot gspread google-auth python-dotenv
        
    - name: Create .env file
      run: |
        echo "BOT_TOKEN=${{ secrets.BOT_TOKEN }}" >> .env
        echo "CHAT_ID=${{ secrets.CHAT_ID }}" >> .env
        echo "GOOGLE_SHEETS_CREDENTIALS=${{ secrets.GOOGLE_SHEETS_CREDENTIALS }}" >> .env
        echo "SPREADSHEET_ID=${{ secrets.SPREADSHEET_ID }}" >> .env
        
    - name: Run Daily Poll Monitor
      env:
        BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
        CHAT_ID: ${{ secrets.CHAT_ID }}
        GOOGLE_SHEETS_CREDENTIALS: ${{ secrets.GOOGLE_SHEETS_CREDENTIALS }}
        SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
      run: |
        echo "üïê –ó–∞–ø—É—Å–∫ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–π..."
        echo "üïê –í—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞: $(date)"
        echo "üìÖ –î–µ–Ω—å –Ω–µ–¥–µ–ª–∏: $(date +%u)"
        echo "üìÖ –î–µ–Ω—å –Ω–µ–¥–µ–ª–∏ (–Ω–∞–∑–≤–∞–Ω–∏–µ): $(date +%A)"
        echo "‚ÑπÔ∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–≤–æ–¥–∏—Ç—Å—è 2 —Ä–∞–∑–∞ –≤ –¥–µ–Ω—å: 15:00 –∏ 03:00 –ø–æ –ú–æ—Å–∫–≤–µ"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
        if [ -z "$BOT_TOKEN" ]; then
          echo "‚ùå BOT_TOKEN –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
          exit 1
        fi
        if [ -z "$CHAT_ID" ]; then
          echo "‚ùå CHAT_ID –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
          exit 1
        fi
        if [ -z "$GOOGLE_SHEETS_CREDENTIALS" ]; then
          echo "‚ùå GOOGLE_SHEETS_CREDENTIALS –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
          exit 1
        fi
        if [ -z "$SPREADSHEET_ID" ]; then
          echo "‚ùå SPREADSHEET_ID –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
          exit 1
        fi
        
        echo "‚úÖ –í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã"
        echo "üîÑ –ó–∞–ø—É—Å–∫ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞..."
        echo "=================================================="
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
        echo "üìä –ó–∞–ø—É—Å–∫ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–π..."
        python daily_poll_monitor.py
        
        echo "=================================================="
        echo "–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞"
        
    - name: Check files before cache
      run: |
        echo "üîç –ü–†–û–í–ï–†–ö–ê –§–ê–ô–õ–û–í –ü–ï–†–ï–î –°–û–•–†–ê–ù–ï–ù–ò–ï–ú –í CACHE"
        echo "=================================================="
        if ls poll_votes_*.json 1> /dev/null 2>&1; then
          echo "‚úÖ –§–∞–π–ª—ã –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–π –Ω–∞–π–¥–µ–Ω—ã:"
          ls -la poll_votes_*.json
        else
          echo "‚ÑπÔ∏è –§–∞–π–ª—ã –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
        fi
        echo "=================================================="
        
    - name: Save poll votes cache
      uses: actions/cache@v3
      if: always()
      with:
        path: |
          poll_votes_*.json
        key: poll-votes-${{ github.ref }}
        
    - name: Upload logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: daily-monitor-logs
        path: |
          poll_votes_*.json
          *.log
        retention-days: 7