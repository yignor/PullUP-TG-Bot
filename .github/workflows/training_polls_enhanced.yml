name: Training Polls Management

on:
  schedule:
    # –í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ 07:00 UTC = 10:00 MSK - –°–æ–∑–¥–∞–Ω–∏–µ –æ–ø—Ä–æ—Å–∞
    - cron: '0 7 * * 0'
    # –°—Ä–µ–¥–∞ 07:00 UTC = 10:00 MSK - –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—Ç–æ—Ä–Ω–∏–∫
    - cron: '0 7 * * 3'
    # –°—É–±–±–æ—Ç–∞ 07:00 UTC = 10:00 MSK - –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –∑–∞ –ø—è—Ç–Ω–∏—Ü—É
    - cron: '0 7 * * 6'
  workflow_dispatch:
    inputs:
      action:
        description: '–î–µ–π—Å—Ç–≤–∏–µ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è'
        required: true
        default: 'check'
        type: choice
        options:
        - check
        - create_poll
        - collect_tuesday
        - collect_friday

jobs:
  training-polls:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install python-telegram-bot gspread google-auth python-dotenv
        
    - name: Create .env file
      run: |
        echo "BOT_TOKEN=${{ secrets.BOT_TOKEN }}" >> .env
        echo "CHAT_ID=${{ secrets.CHAT_ID }}" >> .env
        echo "ANNOUNCEMENTS_TOPIC_ID=${{ secrets.ANNOUNCEMENTS_TOPIC_ID }}" >> .env
        echo "GOOGLE_SHEETS_CREDENTIALS=${{ secrets.GOOGLE_SHEETS_CREDENTIALS }}" >> .env
        echo "SPREADSHEET_ID=${{ secrets.SPREADSHEET_ID }}" >> .env
        
    - name: Run Training Polls Management
      env:
        BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
        CHAT_ID: ${{ secrets.CHAT_ID }}
        ANNOUNCEMENTS_TOPIC_ID: ${{ secrets.ANNOUNCEMENTS_TOPIC_ID }}
        GOOGLE_SHEETS_CREDENTIALS: ${{ secrets.GOOGLE_SHEETS_CREDENTIALS }}
        SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
      run: |
        echo "üèÄ –ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–ø—Ä–æ—Å–∞–º–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫..."
        echo "üïê –í—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞: $(date)"
        echo "üìÖ –î–µ–Ω—å –Ω–µ–¥–µ–ª–∏: $(date +%u)"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
        if [ -z "$BOT_TOKEN" ]; then
          echo "‚ùå BOT_TOKEN –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
          exit 1
        fi
        if [ -z "$CHAT_ID" ]; then
          echo "‚ùå CHAT_ID –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
          exit 1
        fi
        if [ -z "$GOOGLE_SHEETS_CREDENTIALS" ]; then
          echo "‚ùå GOOGLE_SHEETS_CREDENTIALS –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
          exit 1
        fi
        if [ -z "$SPREADSHEET_ID" ]; then
          echo "‚ùå SPREADSHEET_ID –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
          exit 1
        fi
        
        echo "‚úÖ –í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã"
        echo "üîÑ –ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–ø—Ä–æ—Å–∞–º–∏..."
        
        python training_polls_enhanced.py
        
    - name: Upload logs
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: training-polls-logs
        path: |
          *.json
          *.log
        retention-days: 7
