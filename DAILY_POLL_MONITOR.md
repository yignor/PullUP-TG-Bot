# Ежедневный мониторинг голосований за тренировки

## Описание

Система ежедневного мониторинга автоматически отслеживает изменения в голосованиях за тренировки и обновляет Google таблицу в реальном времени.

## Принцип работы

### Расписание проверок

- **Воскресенье**: Создается опрос на неделю
- **Понедельник-среда**: Активен мониторинг голосов за вторник
- **Понедельник-суббота**: Активен мониторинг голосов за пятницу
- **Каждый день в 8:00 UTC (11:00 МСК)**: Автоматическая проверка изменений

### Схема работы

```
Воскресенье: Создание опроса
     ↓
Понедельник: Мониторинг (Вторник + Пятница)
     ↓
Вторник: Мониторинг (Вторник + Пятница)
     ↓
Среда: Мониторинг (Вторник + Пятница) → Вторник заканчивается
     ↓
Четверг: Мониторинг (Пятница)
     ↓
Пятница: Мониторинг (Пятница)
     ↓
Суббота: Мониторинг (Пятница) → Пятница заканчивается
     ↓
Воскресенье: Новый цикл
```

### Процесс мониторинга

```
1. Получение текущих голосов из Telegram
   ↓
2. Загрузка предыдущих голосов из файла
   ↓
3. Сравнение и выявление изменений
   ↓
4. Обновление Google таблицы:
   - Добавление новых голосов
   - Удаление отмененных голосов
   - Обновление измененных голосов
   ↓
5. Сохранение текущих голосов для следующей проверки
```

### Логика мониторинга

1. **Получение текущих голосов**: Система получает актуальные голоса через Telegram API
2. **Сравнение с предыдущими**: Сравнивает с сохраненными голосами предыдущей проверки
3. **Выявление изменений**:
   - Новые голоса → добавление в таблицу
   - Пропавшие голоса → удаление из таблицы
   - Измененные голоса → обновление в таблице

## Файлы системы

### Основные файлы

- `daily_poll_monitor.py` - Основной класс мониторинга
- `run_daily_poll_monitor.py` - Скрипт запуска
- `.github/workflows/daily_poll_monitor.yml` - GitHub Actions workflow

### Файлы данных

- `poll_votes_{poll_id}.json` - Сохраненные голоса для каждого опроса
- `current_poll_info.json` - Информация о текущем опросе

## Использование

### Автоматический запуск

Система запускается автоматически каждый день в 8:00 UTC через GitHub Actions.

### Ручной запуск

```bash
python run_daily_poll_monitor.py
```

### Запуск через GitHub Actions

Можно запустить вручную через интерфейс GitHub Actions (кнопка "Run workflow").

## Логика определения активных опросов

```python
def get_active_polls_info(self) -> Dict[str, Any]:
    weekday = now.weekday()  # 0=понедельник, 6=воскресенье
    
    active_polls = {}
    
    # Понедельник-среда: активен опрос за вторник
    if weekday >= 0 and weekday <= 2:
        active_polls['tuesday'] = {
            'day': 'Вторник',
            'active': True,
            'ends': 'среда'
        }
    
    # Понедельник-суббота: активен опрос за пятницу
    if weekday >= 0 and weekday <= 5:
        active_polls['friday'] = {
            'day': 'Пятница', 
            'active': True,
            'ends': 'суббота'
        }
    
    return active_polls
```

## Обработка изменений

### Типы изменений

1. **Новые голоса** - пользователь проголосовал впервые
2. **Удаленные голоса** - пользователь отменил голос
3. **Измененные голоса** - пользователь изменил выбор

### Логика обработки

```python
# Добавление нового голоса
if 0 in vote['options'] and day == 'Вторник':
    self.add_voter_to_sheet(vote['name'], day)

# Удаление пропавшего голоса
if 0 in previous_vote['options'] and day == 'Вторник' and 0 not in current_vote['options']:
    self.remove_voter_from_sheet(previous_vote['name'], day)
```

## Работа с Google таблицей

### Структура таблицы

- **Колонка A**: Пустая (для группировки)
- **Колонка B**: Пустая (для группировки)
- **Колонка C**: Фамилия
- **Колонка D**: Имя
- **Колонка E**: Пустая

### Операции с таблицей

1. **Добавление участника**: Вставляет новую строку в нужное место
2. **Удаление участника**: Удаляет строку с соответствующим именем
3. **Поиск существующих**: Читает все данные для проверки дубликатов

## Преимущества новой системы

### По сравнению с предыдущей системой

1. **Надежность**: Не зависит от ограничений Telegram API на количество обновлений
2. **Актуальность**: Обновления вносятся в реальном времени
3. **Точность**: Отслеживает все изменения, включая отмены голосов
4. **Автоматизация**: Полностью автоматический процесс

### Решение проблем

- ✅ Проблема с получением старых голосов
- ✅ Пропуск изменений в голосах
- ✅ Дублирование участников
- ✅ Ручное обновление таблицы

## Мониторинг и логирование

### Логи системы

Система выводит подробные логи:
- Количество найденных изменений
- Список добавленных/удаленных участников
- Ошибки и предупреждения

### GitHub Actions

- Автоматический запуск каждый день
- Логирование результатов
- Загрузка артефактов при ошибках

## Настройка

### Переменные окружения

Требуются те же переменные, что и для основной системы:
- `BOT_TOKEN`
- `CHAT_ID`
- `GOOGLE_SHEETS_CREDENTIALS`
- `SPREADSHEET_ID`

### GitHub Secrets

Все переменные должны быть настроены в GitHub Secrets для автоматического запуска.

## Тестирование

### Локальное тестирование

```bash
# Установка зависимостей
pip install -r requirements-github.txt

# Запуск мониторинга
python run_daily_poll_monitor.py
```

### Тестирование через GitHub Actions

Можно запустить workflow вручную через интерфейс GitHub для проверки работы.

## Устранение неполадок

### Частые проблемы

1. **Ошибка инициализации Google Sheets**
   - Проверить `GOOGLE_SHEETS_CREDENTIALS`
   - Убедиться, что лист "Тренировки" существует

2. **Ошибка получения голосов**
   - Проверить `BOT_TOKEN` и `CHAT_ID`
   - Убедиться, что опрос активен

3. **Проблемы с таблицей**
   - Проверить права доступа к Google Sheets
   - Убедиться в правильности структуры таблицы

### Логи для диагностики

Все операции логируются с подробным описанием. При ошибках в GitHub Actions загружаются артефакты с логами.
