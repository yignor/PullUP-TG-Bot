# Руководство по парсингу fallback-источников

## Как работает система определения команды

### 1. Определение команды по ID

Система получает ID команды из:
- **API Infobasket** - при парсинге расписания через `fetch_infobasket_schedule()`
- **Google Sheets конфигурация** - из листа "Конфиг", блок "Команды" (CONFIG_TEAM)

**Важно:** ID команды ≠ ID соревнования!

- **ID соревнования (comp_id)**: например, `110852`, `112592` - это соревнования/лиги
- **ID команды (team_id)**: например, `36502`, `42347` - это конкретные команды

### 2. Получение названия команды по ID

```python
# Из конфигурации Google Sheets
team_name = manager._resolve_team_name(team_id)
# Возвращает: "Молодые качки" или None, если не найдено

# С вариантами названия
variants = manager._build_name_variants(team_name)
# Возвращает: {"Молодые качки", "молодыекачки", "Молодые", "качки"}
```

### 3. Парсинг сайта без знания ID команды

Если на сайте (например, mb-78.ru) есть команда "Flash", но мы не знаем её ID:

#### Вариант 1: Поиск по названию команды

1. **Добавить команду в конфигурацию по названию:**
   ```
   ТИП: CONFIG_TEAM
   ИД КОМАНДЫ: (оставить пустым или указать 0)
   АЛЬТЕРНАТИВНОЕ ИМЯ: Flash
   НАСТРОЙКИ (JSON): {"aliases": ["Flash", "Флеш"]}
   ```

2. **Fallback парсер будет искать по названию:**
   - Строит варианты: `{"Flash", "flash", "Флеш", "флеш"}`
   - Ищет в тексте ссылок на сайте: `"Flash - U-Питер"`
   - Находит совпадение и возвращает ссылку

#### Вариант 2: Определить ID команды из API

Если команда участвует в соревновании, можно найти её ID через API:

```python
# Получить все игры соревнования
comp_id = 110852  # ID соревнования
games = await parser.get_calendar_for_comp(comp_id)

# Найти команду "Flash" в играх
for game in games:
    team1_name = game.get('ShortTeamNameAru', '')
    team2_name = game.get('ShortTeamNameBru', '')
    team1_id = game.get('Team1ID')
    team2_id = game.get('Team2ID')
    
    if 'Flash' in team1_name:
        print(f"Найдена команда Flash: ID = {team1_id}")
    if 'Flash' in team2_name:
        print(f"Найдена команда Flash: ID = {team2_id}")
```

### 4. Как работает fallback для mb-78.ru

**Текущая логика:**

1. Система получает названия команд (из конфигурации или API)
2. Строит варианты названий: `_build_name_variants("Flash")` → `{"Flash", "flash"}`
3. Парсит сайт mb-78.ru, ищет ссылки с `gameId=` или `game.html`
4. **Улучшение:** Проверяет текст ссылки (например, "Flash - U-Питер")
5. Если обе команды найдены в тексте → возвращает ссылку
6. Если не найдено → проверяет содержимое страницы игры

**Пример работы:**

```
Команда 1: "Flash" → варианты: {"Flash", "flash"}
Команда 2: "U-Питер" → варианты: {"U-Питер", "uпитер", "U", "Питер"}

На сайте найдена ссылка: "Flash - U-Питер"
  → Проверка: "Flash" найден ✅, "U-Питер" найден ✅
  → Возвращаем ссылку: http://mb-78.ru/game.html?gameId=973178
```

### 5. Добавление mb-78.ru в fallback-источники

В Google Sheets (лист "Конфиг") добавьте:

```
ТИП: FALLBACK_SOURCE
URL FALLBACK: http://mb-78.ru/
НАЗВАНИЕ FALLBACK: mb-78.ru
```

Или в коде (временное решение):
```python
sources = self.fallback_sources or [
    {'url': 'http://letobasket.ru/'},
    {'url': 'http://mb-78.ru/'}  # Новый источник
]
```

### 6. Что делать, если команда "Flash" не в конфигурации?

**Вариант A: Добавить по названию (без ID)**
```
ТИП: CONFIG_TEAM
ИД КОМАНДЫ: 0  (или оставить пустым)
АЛЬТЕРНАТИВНОЕ ИМЯ: Flash
НАСТРОЙКИ: {"aliases": ["Flash", "Флеш", "flash"]}
```

**Вариант B: Найти ID через API и добавить**
1. Запустить скрипт поиска ID команды
2. Найти ID команды "Flash" в API
3. Добавить в конфигурацию с правильным ID

### 7. Пример: Поиск игр для команды "Flash" на mb-78.ru

```python
# 1. Получаем варианты названия
team_variants = manager._build_name_variants("Flash")
# {"Flash", "flash"}

# 2. Парсим сайт
async with aiohttp.ClientSession() as session:
    result = await manager._search_fallback_source(
        session,
        "http://mb-78.ru/",
        team_variants,  # Наша команда
        {"U-Питер", "uпитер"}  # Соперник
    )
    
# 3. Результат: ("http://mb-78.ru/game.html?gameId=973178", "Flash")
```

## Итого

- **110852** - это ID соревнования, не команды
- Для парсинга сайта нужны **названия команд**, а не только ID
- Fallback парсер работает по **названиям команд** из конфигурации
- Если команда не в конфигурации, можно добавить её по названию (без ID)
- Улучшенный парсер проверяет текст ссылки перед загрузкой страницы (быстрее)

