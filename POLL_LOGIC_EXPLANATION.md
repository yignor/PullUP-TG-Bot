# Логика работы с опросами тренировок

## 🎯 Принцип работы

Бот работает по следующему принципу:

1. **Воскресенье 9:00** - Создается один опрос на всю неделю
2. **Среда 9:00** - Собираются данные из этого опроса
3. **Суббота 9:00** - Снова собираются данные из этого же опроса
4. **Следующее воскресенье 9:00** - Создается новый опрос

## 📅 Детальная логика

### Создание опроса (Воскресенье 9:00)

```python
# Функция проверки времени
async def should_create_weekly_poll() -> bool:
    now = datetime.datetime.now()
    return now.weekday() == 6 and now.hour == 9 and now.minute < 30
```

**Что происходит:**
- Бот проверяет, что сейчас воскресенье (weekday == 6)
- Время между 9:00 и 9:29
- Создается опрос "Тренировки на неделе" с вариантами:
  - Вторник СШОР 19:00
  - Среда 550 школа 19:00
  - Пятница СШОР 20:30
  - Нет
  - Тренер

### Сбор данных (Среда/Суббота 9:00)

```python
# Функция проверки времени
async def should_collect_attendance() -> bool:
    now = datetime.datetime.now()
    return (now.weekday() in [2, 5]) and now.hour == 9 and now.minute < 30
```

**Что происходит:**
- Бот проверяет, что сейчас среда (2) или суббота (5)
- Время между 9:00 и 9:29
- Ищет **последний опрос**, созданный в воскресенье

### Поиск последнего опроса

```python
async def get_latest_sunday_training_poll():
    # Ищем опросы за последние 7 дней
    since = datetime.datetime.now() - datetime.timedelta(days=7)
    
    # Получаем сообщения с поиском "Тренировки на неделе"
    messages = await self.client.get_messages(
        chat_id=CHAT_ID,
        search='Тренировки на неделе',
        limit=50,
        offset_date=since
    )
    
    # Фильтруем только опросы, созданные в воскресенье
    sunday_polls = []
    for message in messages:
        if message.poll and "тренировки" in message.poll.question.lower():
            if message.date.weekday() == 6:  # 6 = воскресенье
                sunday_polls.append(poll_data)
    
    # Возвращаем самый последний (первый в списке)
    return sunday_polls[0] if sunday_polls else None
```

## 🔍 Пример работы

### Неделя 1:
- **Воскресенье 9:00** - Создается опрос "Тренировки на неделе"
- **Среда 9:00** - Собираются данные из этого опроса
- **Суббота 9:00** - Снова собираются данные из этого же опроса

### Неделя 2:
- **Воскресенье 9:00** - Создается новый опрос "Тренировки на неделе"
- **Среда 9:00** - Собираются данные из нового опроса
- **Суббота 9:00** - Снова собираются данные из нового опроса

## 📊 Структура данных

### В Google Sheets сохраняется:

| Дата опроса | День недели | Тренировка | Участники | Количество |
|-------------|-------------|------------|-----------|------------|
| 2024-01-14  | Вторник     | Вторник СШОР 19:00 | Игрок1, Игрок2 | 2 |
| 2024-01-14  | Среда       | Среда 550 школа 19:00 | Игрок2, Игрок3 | 2 |
| 2024-01-14  | Пятница     | Пятница СШОР 20:30 | Игрок1, Игрок4 | 2 |

**Важно:** Дата в таблице - это дата создания опроса (воскресенье), а не дата тренировки.

## ⚠️ Особенности и ограничения

### 1. Один опрос на неделю
- Каждое воскресенье создается только один опрос
- Среда и суббота обрабатывают один и тот же опрос
- Это позволяет отслеживать изменения в голосовании

### 2. Поиск по дате создания
- Бот ищет опросы, созданные именно в воскресенье
- Игнорирует опросы, созданные в другие дни
- Ищет за последние 7 дней

### 3. Обработка голосов
- Если опрос анонимный - получаем только количество голосов
- Если опрос публичный - можно получить имена участников
- Поддерживается множественный выбор

### 4. Обработка ошибок
- Если опрос не найден - выводится предупреждение
- Если нет голосов - сохраняется пустая запись
- Если ошибка API - логируется ошибка

## 🧪 Тестирование логики

### Тест поиска последнего опроса:
```bash
python test_latest_poll.py
```

### Ожидаемый вывод:
```
✅ Найден последний опрос тренировок от 2024-01-14 09:00
📊 Найден последний опрос тренировок:
   Вопрос: Тренировки на неделе
   Дата создания: 2024-01-14T09:00:00
   Всего голосов: 8
   Анонимный: False
   Множественный выбор: True

📋 Варианты ответов:
   1. Вторник СШОР 19:00: 3 голоса
   2. Среда 550 школа 19:00: 2 голоса
   3. Пятница СШОР 20:30: 4 голоса
   4. Нет: 1 голос
   5. Тренер: 0 голосов

👥 Участники по дням:
   Вторник: 3 участников
   Среда: 2 участников
   Пятница: 4 участников
```

## 🔧 Настройка и отладка

### Проверка переменных окружения:
```bash
# Обязательные для поиска опросов:
TELEGRAM_API_ID=12345678
TELEGRAM_API_HASH=abcdef1234567890abcdef1234567890
TELEGRAM_PHONE=+79001234567
CHAT_ID=your_chat_id
ANNOUNCEMENTS_TOPIC_ID=your_topic_id
```

### Проверка логики:
```bash
# Тест поиска опроса
python test_latest_poll.py

# Тест сбора данных
python -c "
import asyncio
from training_polls import collect_attendance_data
result = asyncio.run(collect_attendance_data())
print('Результат:', result)
"
```

## 📈 Преимущества такой логики

1. **Простота** - один опрос на неделю
2. **Надежность** - четкий алгоритм поиска
3. **Отслеживание изменений** - можно видеть, как меняются голоса
4. **Эффективность** - минимум запросов к API
5. **Понятность** - логика соответствует реальному процессу

## 🎯 Заключение

**Да, бот будет проверять только 1 опрос каждую среду и субботу - тот, который был создан в последнее воскресенье.**

Это обеспечивает:
- ✅ Стабильную работу
- ✅ Простоту понимания
- ✅ Эффективное использование ресурсов
- ✅ Корректное отслеживание посещаемости
