# Обновление системы мониторинга опросов

## Обзор изменений

Система мониторинга опросов была расширена для поддержки четверга и улучшена для предотвращения ложных обновлений.

## Основные изменения

### 1. Поддержка четверга

#### Создание опросов
- Опросы теперь включают три дня: вторник, четверг и пятница
- Варианты ответов:
  - 0: Вторник, 21:30, зал Динамо (Крестовский остров)
  - 1: Четверг, 21:30, зал Динамо (Игровая тренировка, максимум 9 человек)
  - 2: Пятница, 20:30, зал СШОР ВО
  - 3: Тренер
  - 4: Нет

#### Структура Google Sheets
- Добавлена поддержка секции "Четверг" в листе "Тренировки"
- Индекс структуры обновлен для включения `thursday_sections`
- Логика поиска и обработки участников расширена для четверга

### 2. Ежедневный мониторинг

#### Расписание проверок
- **Понедельник-суббота**: проверка всех вариантов ответов (вторник, четверг, пятница)
- **2 раза в день**: утром (11:00 MSK) и вечером (23:00 MSK)
- **Каждая проверка**: анализирует все голоса и обновляет все секции в Google Sheets

#### GitHub Actions
- Создан новый workflow `daily_poll_monitor.yml`
- 2 проверки в день: утром (11:00 MSK) и вечером (23:00 MSK)
- Обновлен `training_polls_enhanced.yml` для включения четверга

### 3. Система детекции изменений

#### Компоненты
- `poll_change_detector.py` - основная система детекции
- `daily_poll_monitor.py` - интегрированный мониторинг
- Файлы истории: `poll_change_history.json`, `poll_false_positives.json`

#### Функции
- **Хеширование данных**: создание уникальных хешей для отслеживания изменений
- **Confidence Score**: оценка уверенности в изменениях (0.0-1.0)
- **Детекция ложных срабатываний**: предотвращение некорректных обновлений
- **Статистика изменений**: отслеживание паттернов и трендов

#### Логика принятия решений
- Высокая уверенность (≥0.7): изменения применяются
- Средняя уверенность (0.5-0.7): дополнительные проверки
- Низкая уверенность (<0.5): изменения отклоняются как ложные срабатывания

## Файлы системы

### Основные модули
- `training_polls_enhanced.py` - создание и сбор данных опросов
- `daily_poll_monitor.py` - ежедневный мониторинг
- `poll_change_detector.py` - система детекции изменений

### GitHub Actions
- `.github/workflows/training_polls_enhanced.yml` - управление опросами
- `.github/workflows/daily_poll_monitor.yml` - ежедневный мониторинг

### Файлы данных
- `poll_monitor_history.json` - история мониторинга
- `poll_changes_log.json` - лог изменений
- `poll_change_history.json` - детальная история изменений
- `poll_false_positives.json` - история ложных срабатываний
- `poll_votes_*.json` - кэш голосов по опросам

## Структура Google Sheets

### Лист "Тренировки"
```
A: Дата создания опроса
B: ID опроса / День недели
C: Фамилия
D: Имя  
E: Telegram ID
F: Дополнительная информация
```

### Секции дней
- **Вторник**: участники вторника
- **Четверг**: участники четверга (новое)
- **Пятница**: участники пятницы

## Алгоритм мониторинга

### 1. Получение данных
- Загрузка текущих голосов из Telegram API
- Получение существующих участников из Google Sheets
- Сравнение с предыдущим состоянием

### 2. Детекция изменений
- Создание хешей для сравнения состояний
- Анализ добавленных/удаленных/измененных голосов
- Вычисление confidence score

### 3. Принятие решения
- Проверка на ложные срабатывания
- Анализ исторических данных
- Применение или отклонение изменений

### 4. Обновление данных
- **Проверка всех дней одновременно**: вторник, четверг, пятница
- Добавление новых участников в соответствующие секции Google Sheets
- Удаление пропавших участников из всех секций
- Логирование всех операций с детализацией по дням

## Настройка и развертывание

### Переменные окружения
```bash
BOT_TOKEN=your_telegram_bot_token
CHAT_ID=your_chat_id
ANNOUNCEMENTS_TOPIC_ID=your_topic_id
GOOGLE_SHEETS_CREDENTIALS=your_credentials_json
SPREADSHEET_ID=your_spreadsheet_id
```

### Зависимости
```bash
pip install python-telegram-bot gspread google-auth python-dotenv
```

### Запуск
```bash
# Создание опросов
python training_polls_enhanced.py

# Ежедневный мониторинг
python daily_poll_monitor.py
```

## Мониторинг и отладка

### Логи
- Все операции логируются с временными метками
- Детальная информация об изменениях
- Статистика confidence scores

### Статистика
- Количество примененных изменений
- Процент ложных срабатываний
- Средняя уверенность в изменениях

### Очистка данных
- Автоматическая очистка данных старше 30 дней
- Ручная очистка через `cleanup_old_data()`

## Преимущества новой системы

1. **Стабильность**: предотвращение ложных обновлений
2. **Полнота**: поддержка всех трех дней тренировок
3. **Надежность**: система детекции изменений с confidence scoring
4. **Мониторинг**: подробная статистика и логирование
5. **Автоматизация**: полная автоматизация через GitHub Actions

## Совместимость

Система обратно совместима с существующими данными и может работать с опросами, созданными до обновления.
