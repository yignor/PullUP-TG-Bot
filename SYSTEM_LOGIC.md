# Логика работы системы бота

## 🎯 Основная архитектура

### 1. ИГРЫ (Приоритет: API → Fallback)
```
┌─────────────────────────────────────────────────────────────┐
│                    СИСТЕМА УПРАВЛЕНИЯ ИГРАМИ                │
│                    (game_system_manager.py)                 │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                    ШАГ 1: ПАРСИНГ РАСПИСАНИЯ                │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│  🔍 ПЕРВООЧЕРЕДНАЯ ПРОВЕРКА: Infobasket Smart API          │
│  • Получает данные через infobasket_smart_parser.py        │
│  • Использует API: reg.infobasket.su/Comp/GetCalendar/     │
│  • Правильная обработка дат с московским временем          │
│  • Создает ссылки: letobasket.ru/game.html?gameId=XXX      │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
                    ┌─────────────────┐
                    │ Есть данные?    │
                    └─────────────────┘
                            │
                    ┌───────┴───────┐
                    │               │
                   ДА               НЕТ
                    │               │
                    ▼               ▼
┌─────────────────────────────────────────────────────────────┐
│  ✅ ИСПОЛЬЗУЕМ API ДАННЫЕ                                   │
│  • Создаем опросы для будущих игр                           │
│  • Отправляем анонсы для сегодняшних игр                    │
│  • Используем готовые ссылки из API                         │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│  🔄 FALLBACK: letobasket.ru парсинг                         │
│  • Парсит HTML страницу letobasket.ru                       │
│  • Исправляет названия команд (например, "Атлант 40")      │
│  • Ищет ссылки в табло для анонсов                          │
└─────────────────────────────────────────────────────────────┘
```

### 2. ТРЕНИРОВКИ (Конфигурация через сервисный лист)
```
┌─────────────────────────────────────────────────────────────┐
│              СИСТЕМА УПРАВЛЕНИЯ ТРЕНИРОВКАМИ               │
│              (training_polls_enhanced.py)                  │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│  📅 КОНФИГ С ЧЕРЕЗ GOOGLE SHEETS                           │
│  • Каждая строка `TRAINING_POLL` описывает самостоятельный │
│    опрос: название, день недели, время, локация, опции,    │
│    топик.                                                  │
│  • Скрипт ежедневно считывает конфигурацию и создает       │
│    ближайшие опросы.                                       │
└─────────────────────────────────────────────────────────────┘
```

### 3. ДНИ РОЖДЕНИЯ
```
┌─────────────────────────────────────────────────────────────┐
│        СИСТЕМА УВЕДОМЛЕНИЙ О ДНЯХ РОЖДЕНИЯ (birthday_notifications.py)        │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│  📅 РАСПИСАНИЕ: GitHub Actions                              │
│  • Каждый день 09:00 MSK - Проверка дней рождения          │
│  • Отправка уведомлений в Telegram                         │
└─────────────────────────────────────────────────────────────┘
```

## 🔧 GitHub Actions Workflows

### Игры
- **game_announcements.yml**: Основная система управления играми (10:00 MSK)
- **game_results_monitor_v2.yml**: Мониторинг результатов игр (каждые 15 минут)

### Тренировки
- **training_polls_enhanced.yml**: Создание опросов тренировок по конфигурации

### Дни рождения
- **birthday_notifications.yml**: Уведомления о днях рождения

### Сервисные
- **cleanup_service_sheet.yml**: Очистка Google Sheets

## 📊 Логика приоритетов для игр

1. **ПЕРВООЧЕРЕДНО**: Infobasket Smart API
   - ✅ Надежный источник данных
   - ✅ Правильная обработка дат
   - ✅ Готовые ссылки на игры
   - ✅ Поддержка московского времени

2. **FALLBACK**: letobasket.ru парсинг
   - ✅ Используется только если API не работает
   - ✅ Исправляет названия команд
   - ✅ Ищет ссылки в табло

3. **ЗАЩИТА ОТ ДУБЛИРОВАНИЯ**: Google Sheets
   - ✅ История опросов и анонсов
   - ✅ Предотвращение повторных отправок

## 🎯 Результат

- **Игры**: API → Fallback (новая логика)
- **Тренировки**: Конфигурация через сервисный лист
- **Дни рождения**: Автоматические уведомления с проверкой дублей
