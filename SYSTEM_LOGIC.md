# Логика работы системы бота

## 🎯 Основная архитектура

### 1. ИГРЫ (Приоритет: API → Fallback)
```
┌─────────────────────────────────────────────────────────────┐
│                    СИСТЕМА УПРАВЛЕНИЯ ИГРАМИ                │
│                    (game_system_manager.py)                 │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                    ШАГ 1: ПАРСИНГ РАСПИСАНИЯ                │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│  🔍 ПЕРВООЧЕРЕДНАЯ ПРОВЕРКА: Infobasket Smart API          │
│  • Получает данные через infobasket_smart_parser.py        │
│  • Использует API: reg.infobasket.su/Comp/GetCalendar/     │
│  • Правильная обработка дат с московским временем          │
│  • Создает ссылки: letobasket.ru/game.html?gameId=XXX      │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
                    ┌─────────────────┐
                    │ Есть данные?    │
                    └─────────────────┘
                            │
                    ┌───────┴───────┐
                    │               │
                   ДА               НЕТ
                    │               │
                    ▼               ▼
┌─────────────────────────────────────────────────────────────┐
│  ✅ ИСПОЛЬЗУЕМ API ДАННЫЕ                                   │
│  • Создаем опросы для будущих игр                           │
│  • Отправляем анонсы для сегодняшних игр                    │
│  • Используем готовые ссылки из API                         │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│  🔄 FALLBACK: letobasket.ru парсинг                         │
│  • Парсит HTML страницу letobasket.ru                       │
│  • Исправляет названия команд (например, "Атлант 40")      │
│  • Ищет ссылки в табло для анонсов                          │
└─────────────────────────────────────────────────────────────┘
```

### 2. ГОЛОСОВАНИЯ (Конфигурация через сервисный лист)
```
┌─────────────────────────────────────────────────────────────┐
│              СИСТЕМА УПРАВЛЕНИЯ ГОЛОСОВАНИЯМИ              │
│              (training_polls_enhanced.py)                  │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│  📅 КОНФИГ С ЧЕРЕЗ GOOGLE SHEETS                           │
│  • Строки, объединённые по `poll_id`, задают одно          │
│    голосование: тему, варианты, дни недели и параметры.    │
│  • Колонка `ID топика` задаёт поток публикации; пусто —     │
│    отправка в основной чат.                                 │
│  • Колонки `Анонимный`, `Множественный выбор`,              │
│    `Время (мин)` и `Закрыть (дата)` заполняются напрямую,   │
│    без JSON, что снижает риск опечаток.                     │
│  • Ежедневно в 09:00 по Москве скрипт перечитывает         │
│    конфигурацию и запускает голосования на нужные дни.     │
│  • Ниже расположен блок «Автоматические сообщения»         │
│    с настройкой топиков и флагов для остальных             │
│    авто-рассылок (дни рождения, анонсы, игровые             │
│    опросы).                                                 │
└─────────────────────────────────────────────────────────────┘
```

### 3. ДНИ РОЖДЕНИЯ
```
┌─────────────────────────────────────────────────────────────┐
│        СИСТЕМА УВЕДОМЛЕНИЙ О ДНЯХ РОЖДЕНИЯ (birthday_notifications.py)        │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│  📅 РАСПИСАНИЕ: GitHub Actions                              │
│  • Каждый день 09:00 MSK - Проверка дней рождения          │
│  • Отправка уведомлений в Telegram                         │
└─────────────────────────────────────────────────────────────┘
```

## 🔧 GitHub Actions Workflows

### Ежедневные операции (09:00 MSK)
- **birthday_notifications.yml**: единый запуск — дни рождения, менеджер голосований и система игр

### Игры (ручной запуск)
- **game_announcements.yml**: резервный запуск системы управления играми по требованию
- **game_results_monitor_v2.yml**: мониторинг результатов игр (каждые 15 минут в матчевые окна)

### Голосования (ручной запуск)
- **training_polls_enhanced.yml**: отдельный запуск менеджера голосований при необходимости

### Сервисные
- **cleanup_service_sheet.yml**: ежедневная очистка Google Sheets (05:00 MSK)

## 📊 Логика приоритетов для игр

1. **ПЕРВООЧЕРЕДНО**: Infobasket Smart API
   - ✅ Надежный источник данных
   - ✅ Правильная обработка дат
   - ✅ Готовые ссылки на игры
   - ✅ Поддержка московского времени

2. **FALLBACK**: letobasket.ru парсинг
   - ✅ Используется только если API не работает
   - ✅ Исправляет названия команд
   - ✅ Ищет ссылки в табло

3. **ЗАЩИТА ОТ ДУБЛИРОВАНИЯ**: Google Sheets
   - ✅ История опросов и анонсов
   - ✅ Предотвращение повторных отправок

## 🎯 Результат

- **Игры**: API → Fallback (новая логика)
- **Тренировки**: Конфигурация через сервисный лист
- **Дни рождения**: Автоматические уведомления с проверкой дублей
